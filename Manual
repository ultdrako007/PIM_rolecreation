ğŸ“‹ MANUAL DE USO - SCRIPT DE ASIGNACIÃ“N SEGURA PIM
ğŸ¯ DESCRIPCIÃ“N GENERAL
Script modular para la gestiÃ³n segura de asignaciones PIM (Privileged Identity Management) en Entra ID, implementando controles de seguridad graduales por fases y auditorÃ­a completa.

ğŸš€ INICIO RÃPIDO
Requisitos Previos
PowerShell 5.1 o superior

MÃ³dulos: Microsoft.Graph.Identity.Governance, Microsoft.Graph.Identity.SignIns

Permisos de administrador en Entra ID

ConexiÃ³n a internet para Microsoft Graph

InstalaciÃ³n
powershell
# Instalar mÃ³dulos requeridos
Install-Module Microsoft.Graph.Identity.Governance -Force
Install-Module Microsoft.Graph.Identity.SignIns -Force
EjecuciÃ³n BÃ¡sica
powershell
# Modo interactivo (recomendado para nuevos usuarios)
.\Creacion_de_roles_PIM.ps1

# Modo por parÃ¡metros (para automatizaciÃ³n)
.\Creacion_de_roles_PIM.ps1 -CsvPath "asignaciones.csv" -Phase 2 -DryRun
ğŸ“Š ESTRUCTURA DEL CSV
Columnas Requeridas
csv
PrincipalId,RoleDefinitionId,DirectoryScopeId,Duration,Reason
Ejemplo de Archivo CSV
csv
PrincipalId,RoleDefinitionId,DirectoryScopeId,Duration,Reason
12345678-1234-1234-1234-123456789012,62e90394-69f5-4237-9190-012177145e10,/,PT8H,Incidente: INC-12345 - Acceso de emergencia
87654321-4321-4321-4321-210987654321,194ae4cb-b126-40b2-bd5b-6091b380977d,/,PT4H,Proyecto: MigraciÃ³n seguridad - Requiere permisos temporales
Formatos Aceptados
Campo	Formato	Ejemplo	DescripciÃ³n
PrincipalId	GUID	12345678-1234-1234-1234-123456789012	ID del usuario o service principal
RoleDefinitionId	GUID	62e90394-69f5-4237-9190-012177145e10	ID del rol de Entra ID
DirectoryScopeId	GUID	/	Ãmbito del rol (usar / para global)
Duration	ISO-8601	PT8H, P1D, P7D	DuraciÃ³n de la asignaciÃ³n
Reason	Texto	Incidente: INC-12345	JustificaciÃ³n con referencia de ticket
ğŸ” FASES DE SEGURIDAD
Fase 0 - Controles CrÃ­ticos
powershell
.\Creacion_de_roles_PIM.ps1 -Phase 0 -CsvPath "asignaciones.csv" -DryRun
Validaciones:

âœ… Lista blanca de roles permitidos

âœ… DetecciÃ³n de conflictos con roles permanentes

âœ… VerificaciÃ³n de idempotencia

âœ… Permisos mÃ­nimos de Graph

Fase 1 - Validaciones Avanzadas
powershell
.\Creacion_de_roles_PIM.ps1 -Phase 1 -CsvPath "asignaciones.csv" -DryRun
Validaciones Adicionales:

âœ… Formato de GUID y ISO-8601

âœ… Existencia del PrincipalId en el directorio

âœ… Cumplimiento de duraciones mÃ¡ximas por rol

âœ… VerificaciÃ³n de polÃ­ticas PIM (MFA requerida)

Fase 2 - OptimizaciÃ³n y Robustez
powershell
.\Creacion_de_roles_PIM.ps1 -Phase 2 -CsvPath "asignaciones.csv" -DryRun
CaracterÃ­sticas:

âœ… Manejo de throttling con reintentos

âœ… Nombres descriptivos de roles en reportes

âœ… Reportes de auditorÃ­a mejorados

âœ… Manejo robusto de errores

âš™ï¸ PARÃMETROS DEL SCRIPT
ParÃ¡metros Principales
ParÃ¡metro	Obligatorio	Valores	DescripciÃ³n
CsvPath	âŒ Opcional	Ruta de archivo	Ruta al CSV con asignaciones
Phase	âŒ Opcional	0, 1, 2	Fase de controles de seguridad
DryRun	âŒ Opcional	Switch	Modo simulaciÃ³n sin cambios
Force	âŒ Opcional	Switch	Omite confirmaciones interactivas
Ejemplos de Uso
powershell
# 1. Modo interactivo completo
.\Creacion_de_roles_PIM.ps1

# 2. SimulaciÃ³n en Fase 2
.\Creacion_de_roles_PIM.ps1 -CsvPath "asignaciones.csv" -Phase 2 -DryRun

# 3. ProducciÃ³n con confirmaciÃ³n
.\Creacion_de_roles_PIM.ps1 -CsvPath "asignaciones.csv" -Phase 1

# 4. ProducciÃ³n automÃ¡tica (sin confirmaciones)
.\Creacion_de_roles_PIM.ps1 -CsvPath "asignaciones.csv" -Phase 0 -Force

# 5. ValidaciÃ³n de CSV sin ejecutar
.\Creacion_de_roles_PIM.ps1 -CsvPath "asignaciones.csv" -Phase 1 -DryRun
ğŸ“‹ LISTA BLANCA DE ROLES
Roles Configurados por Default
Tier	Role ID	Nombre	DuraciÃ³n MÃ¡x.	AprobaciÃ³n
Tier0	62e90394-69f5-4237-9190-012177145e10	Global Administrator	PT8H	âœ… Requerida
Tier0	194ae4cb-b126-40b2-bd5b-6091b380977d	Security Administrator	PT8H	âœ… Requerida
Tier1	f28a1f50-f6e7-4571-818b-6a12f2af6b6c	SharePoint Administrator	P1D	âœ… Requerida
Tier1	fe930be7-5e62-47db-91af-98c3a49a38b1	User Administrator	P1D	âŒ No requerida
Tier2	729827e3-9c14-49f7-bb1b-9608f156bbb8	Helpdesk Administrator	P7D	âŒ No requerida
Tier2	88d8e3e3-8f55-4a1e-953a-9b9898b8876b	Directory Readers	P30D	âŒ No requerida
PersonalizaciÃ³n de Roles
Editar la variable $script:AllowedRoles en el script para agregar/modificar roles.

ğŸ” FLUJO DE EJECUCIÃ“N
1. InicializaciÃ³n y MenÃº
text
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              SCRIPT DE ASIGNACIÃ“N SEGURA DE ROLES PIM    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
2. ValidaciÃ³n de Prerequisitos
âœ… MÃ³dulos de PowerShell

âœ… ConexiÃ³n a Microsoft Graph

âœ… Permisos necesarios

âœ… Hash de integridad del CSV

3. Procesamiento por Fases
text
[1/5] Procesando Principal: 12345678-1234-1234-1234-123456789012
âœ“ Eligibilidad creada para Principal: 12345678-1234-1234-1234-123456789012
4. GeneraciÃ³n de Reportes
ğŸ“Š Reporte CSV: PIM_Audit_ABC12345_20231201_143022.csv

ğŸ“‹ Reporte JSON: PIM_Audit_ABC12345_20231201_143022.json

ğŸ“ Log de ejecuciÃ³n: PIM_Logs/PIM_Execution_20231201_143022.log

ğŸ“Š REPORTES DE AUDITORÃA
Estructura del Reporte CSV
csv
Timestamp,PrincipalId,RoleOrGroup,Action,Status,Details,RequestId,ExecutedBy,CsvHash,Phase,DryRun
2023-12-01T14:30:22.123Z,12345678-1234-1234-1234-123456789012,62e90394-69f5-4237-9190-012177145e10,EligibilityCreated,Success,Incidente: INC-12345,req_abc123,admin@tenant.com,abc123...,2,False
EstadÃ­sticas de EjecuciÃ³n
text
=== RESUMEN DE EJECUCIÃ“N ===
Total procesado:  15
Exitoso:          12
Fallido:          1
Omitido:          2
Conflictos:       1
ğŸ› ï¸ RESOLUCIÃ“N DE PROBLEMAS
Errores Comunes y Soluciones
Error	Causa	SoluciÃ³n
ERROR: Archivo CSV no encontrado	Ruta incorrecta	Verificar existencia del archivo
ERROR: MÃ³dulo requerido no instalado	MÃ³dulos faltantes	Ejecutar Install-Module
ERROR: No conectado a Microsoft Graph	Sin sesiÃ³n activa	El script conecta automÃ¡ticamente
ROL BLOQUEADO: ... no estÃ¡ en lista blanca	Rol no autorizado	Agregar rol a $AllowedRoles
CONFLICTO: AsignaciÃ³n permanente existente	Usuario tiene rol permanente	Migrar manualmente a PIM
CÃ³digos de Estado en AuditorÃ­a
Status	Significado	AcciÃ³n
Success	OperaciÃ³n exitosa	Ninguna
Failed	Error en la operaciÃ³n	Revisar detalles
Blocked	Bloqueado por seguridad	Verificar permisos
Warning	Advertencia no crÃ­tica	Revisar configuraciÃ³n
AlreadyExists	Idempotencia detectada	Ninguna
ConflictDetected	Conflicto con rol permanente	Resolver conflicto
ğŸ”’ CONSIDERACIONES DE SEGURIDAD
Controles Implementados
âœ… Lista blanca de roles por Tier

âœ… ValidaciÃ³n de duraciones mÃ¡ximas

âœ… DetecciÃ³n de conflictos con roles permanentes

âœ… VerificaciÃ³n de polÃ­ticas PIM (MFA)

âœ… AuditorÃ­a completa con hash de integridad

âœ… ValidaciÃ³n de existencia de entidades

Mejores PrÃ¡cticas
Siempre usar DryRun primero para validaciones

Empezar con Fase 0 e ir incrementando controles

Revisar reportes de auditorÃ­a despuÃ©s de cada ejecuciÃ³n

Mantener actualizada la lista blanca de roles

Usar justificaciones detalladas con referencias a tickets

ğŸ“ SOPORTE Y MANTENIMIENTO
Monitoreo Recomendado
Revisar logs en PIM_Logs/ despuÃ©s de cada ejecuciÃ³n

Monitorear reportes de auditorÃ­a para detectar anomalÃ­as

Validar periodicamente la lista blanca de roles

PersonalizaciÃ³n
El script estÃ¡ diseÃ±ado para ser modular y fÃ¡cil de personalizar:

Modificar $script:AllowedRoles para agregar roles

Ajustar $script:RequiredPermissions por fase

Personalizar formatos de reporte en Export-AuditReport

