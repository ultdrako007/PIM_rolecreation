#Requires -Module Microsoft.Graph.Identity.Governance

<#
  EFP013
.SYNOPSIS
    Configura los settings de los roles de PIM para Entra ID con controles de seguridad avanzados.
.DESCRIPTION
    Este script obtiene el estado actual, aplica los nuevos cambios con validaciones de seguridad,
    manejo de throttling, modo dry-run y genera reportes de auditor√≠a detallados.
.PARAMETER CsvPath
    Ruta al archivo CSV que contiene la configuraci√≥n de los roles.
.PARAMETER DryRun
    Modo simulaci√≥n - muestra los cambios sin aplicarlos.
.PARAMETER Force
    Omite confirmaciones interactivas para cambios cr√≠ticos.
.PARAMETER LogPath
    Ruta personalizada para los archivos de log y auditor√≠a.
.EXAMPLE
    .\PIM-PolicyConfiguration.ps1 -CsvPath "politicas.csv" -DryRun
    .\PIM-PolicyConfiguration.ps1 -CsvPath "politicas.csv" -Force
#>

param (
    [Parameter(Mandatory = $true)]
    [string]$CsvPath,
    
    [switch]$DryRun,
    [switch]$Force,
    
    [string]$LogPath = ".\PIM-Policy-Logs"
)

# --- CONFIGURACI√ìN GLOBAL ---
$script:ConfigurableRoles = @(
    'Global Administrator',
    'Privileged Role Administrator', 
    'Security Administrator',
    'Exchange Administrator',
    'SharePoint Administrator',
    'User Administrator',
    'Helpdesk Administrator',
    'Service Support Administrator',
    'Billing Administrator',
    'License Administrator',
    'Directory Readers'
)

# Roles cr√≠ticos que requieren aprobaci√≥n y MFA obligatoria
$script:CriticalRoles = @(
    'Global Administrator',
    'Privileged Role Administrator',
    'Security Administrator'
)

# Variables de auditor√≠a
$script:AuditLog = @()
$script:Statistics = @{
    Total = 0
    Success = 0
    Failed = 0
    Skipped = 0
    UnauthorizedChanges = 0
}

# --- FUNCIONES DE UTILIDAD ---

function Invoke-WithRetry {
    <#
    .SYNOPSIS
        Ejecuta comando con reintentos exponenciales ante throttling
    #>
    [CmdletBinding()]
    param(
        [scriptblock]$ScriptBlock,
        [int]$MaxRetries = 3,
        [int]$BaseDelaySeconds = 2
    )
    
    $attempt = 0
    while ($attempt -lt $MaxRetries) {
        try {
            return & $ScriptBlock
        }
        catch {
            if ($_.Exception.Message -match '429|TooManyRequests|throttl') {
                $attempt++
                if ($attempt -ge $MaxRetries) {
                    throw "Fall√≥ despu√©s de $MaxRetries intentos por throttling: $_"
                }
                
                $delay = $BaseDelaySeconds * [Math]::Pow(2, $attempt)
                Write-Warning "Throttling detectado. Reintento $attempt/$MaxRetries en $delay segundos..."
                Start-Sleep -Seconds $delay
            }
            else {
                throw
            }
        }
    }
}

function Test-RoleConfigurable {
    <#
    .SYNOPSIS
        Verifica si un rol est√° en la lista blanca de roles configurables
    #>
    [CmdletBinding()]
    param([string]$RoleDisplayName)
    
    if ($RoleDisplayName -notin $script:ConfigurableRoles) {
        Write-Warning "ROL NO CONFIGURABLE: '$RoleDisplayName' no est√° en la lista blanca de roles configurables"
        return $false
    }
    return $true
}

function Test-UnauthorizedChanges {
    <#
    .SYNOPSIS
        Detecta intentos de reducir controles de seguridad en roles cr√≠ticos
    #>
    [CmdletBinding()]
    param(
        [string]$RoleDisplayName,
        [bool]$CurrentMfa,
        [bool]$ProposedMfa,
        [bool]$CurrentApproval,
        [bool]$ProposedApproval,
        [string]$CurrentDuration,
        [string]$ProposedDuration
    )
    
    $unauthorizedChanges = @()
    
    # Verificar solo para roles cr√≠ticos
    if ($RoleDisplayName -in $script:CriticalRoles) {
        
        # No permitir desactivar MFA en roles cr√≠ticos
        if ($CurrentMfa -and (-not $ProposedMfa)) {
            $unauthorizedChanges += "Desactivar MFA en rol cr√≠tico"
        }
        
        # No permitir desactivar aprobaci√≥n en roles cr√≠ticos
        if ($CurrentApproval -and (-not $ProposedApproval)) {
            $unauthorizedChanges += "Desactivar aprobaci√≥n en rol cr√≠tico"
        }
        
        # No permitir aumentar duraci√≥n m√°s all√° de l√≠mites seguros
        if ($CurrentDuration -and $ProposedDuration) {
            $currentTime = [System.Xml.XmlConvert]::ToTimeSpan($CurrentDuration)
            $proposedTime = [System.Xml.XmlConvert]::ToTimeSpan($ProposedDuration)
            
            # Alertar si se aumenta significativamente la duraci√≥n
            if ($proposedTime -gt $currentTime -and $proposedTime.TotalHours -gt 24) {
                $unauthorizedChanges += "Aumentar duraci√≥n beyond 24 horas en rol cr√≠tico"
            }
        }
    }
    
    return $unauthorizedChanges
}

function Add-AuditEntry {
    <#
    .SYNOPSIS
        Registra evento en el log de auditor√≠a
    #>
    [CmdletBinding()]
    param(
        [string]$RoleDisplayName,
        [string]$Action,
        [string]$Status,
        [string]$Details = '',
        [hashtable]$BeforeState = $null,
        [hashtable]$AfterState = $null
    )
    
    $script:AuditLog += [PSCustomObject]@{
        Timestamp = Get-Date -Format "yyyy-MM-ddTHH:mm:ss.fffZ"
        RoleDisplayName = $RoleDisplayName
        Action = $Action
        Status = $Status
        Details = $Details
        BeforeState = if ($BeforeState) { ($BeforeState | ConvertTo-Json -Compress) } else { '' }
        AfterState = if ($AfterState) { ($AfterState | ConvertTo-Json -Compress) } else { '' }
        ExecutedBy = (Get-MgContext).Account
        DryRun = $DryRun.IsPresent
    }
}

function Export-AuditReport {
    <#
    .SYNOPSIS
        Exporta reportes de auditor√≠a detallados
    #>
    [CmdletBinding()]
    param()
    
    # Crear directorio de logs si no existe
    if (-not (Test-Path $LogPath)) {
        New-Item -ItemType Directory -Path $LogPath -Force | Out-Null
    }
    
    $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
    
    # Exportar CSV detallado
    $csvFile = Join-Path $LogPath "PIM-Policy-Audit_$timestamp.csv"
    $script:AuditLog | Select-Object Timestamp, RoleDisplayName, Action, Status, Details, ExecutedBy, DryRun | 
        Export-Csv -Path $csvFile -NoTypeInformation -Encoding UTF8
    
    # Exportar JSON completo
    $jsonFile = Join-Path $LogPath "PIM-Policy-Audit_$timestamp.json"
    $auditData = @{
        Metadata = @{
            Timestamp = Get-Date -Format "yyyy-MM-ddTHH:mm:ss.fffZ"
            ExecutedBy = (Get-MgContext).Account
            DryRun = $DryRun.IsPresent
            CsvPath = $CsvPath
        }
        Statistics = $script:Statistics
        Entries = $script:AuditLog
    }
    $auditData | ConvertTo-Json -Depth 5 | Out-File $jsonFile -Encoding UTF8
    
    # Mostrar resumen
    Write-Host "`n=== RESUMEN DE EJECUCI√ìN ===" -ForegroundColor Cyan
    Write-Host "Total procesado:  $($script:Statistics.Total)" -ForegroundColor White
    Write-Host "Exitoso:          $($script:Statistics.Success)" -ForegroundColor Green
    Write-Host "Fallido:          $($script:Statistics.Failed)" -ForegroundColor Red
    Write-Host "Omitido:          $($script:Statistics.Skipped)" -ForegroundColor Yellow
    Write-Host "Cambios no autorizados: $($script:Statistics.UnauthorizedChanges)" -ForegroundColor Magenta
    
    Write-Host "`nReportes generados:" -ForegroundColor Cyan
    Write-Host "‚úì CSV detallado: $csvFile" -ForegroundColor Green
    Write-Host "‚úì JSON completo: $jsonFile" -ForegroundColor Green
}

function Show-ConfigurationSummary {
    <#
    .SYNOPSIS
        Muestra resumen de configuraci√≥n antes de ejecutar
    #>
    [CmdletBinding()]
    param([array]$CsvData)
    
    Write-Host "`n" + "="*80 -ForegroundColor Cyan
    Write-Host "           RESUMEN DE CONFIGURACI√ìN PIM" -ForegroundColor Cyan
    Write-Host "="*80 -ForegroundColor Cyan
    Write-Host "üìÅ Archivo CSV: $CsvPath" -ForegroundColor White
    Write-Host "üî¢ Roles a procesar: $($CsvData.Count)" -ForegroundColor White
    Write-Host "üß™ Modo DryRun: $(if($DryRun){'ACTIVADO'}else{'DESACTIVADO'})" -ForegroundColor White
    Write-Host "‚ö° Modo Force: $(if($Force){'ACTIVADO'}else{'DESACTIVADO'})" -ForegroundColor White
    Write-Host "üìä Ruta de logs: $LogPath" -ForegroundColor White
    Write-Host "‚è±Ô∏è  Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor White
    
    Write-Host "`nRoles cr√≠ticos (controles estrictos):" -ForegroundColor Yellow
    $script:CriticalRoles | ForEach-Object { Write-Host "  ‚Ä¢ $_" -ForegroundColor White }
    
    Write-Host "="*80 -ForegroundColor Cyan
}

# --- CONEXI√ìN Y VALIDACI√ìN ---

Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
Write-Host "‚ïë        CONFIGURACI√ìN SEGURA DE POL√çTICAS PIM              ‚ïë" -ForegroundColor Cyan
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan

# Verificaci√≥n e importaci√≥n del m√≥dulo
try {
    Write-Host "Importando m√≥dulo Microsoft.Graph.Identity.Governance..." -ForegroundColor Yellow
    Import-Module Microsoft.Graph.Identity.Governance -ErrorAction Stop
    Write-Host "‚úì M√≥dulo importado correctamente." -ForegroundColor Green
}
catch {
    Write-Error "No se pudo importar el m√≥dulo 'Microsoft.Graph.Identity.Governance'. Por favor, inst√°lalo ejecutando: Install-Module Microsoft.Graph.Identity.Governance -Scope CurrentUser"
    exit 1
}

# Conexi√≥n a Microsoft Graph
Write-Host "Conectando a Microsoft Graph..." -ForegroundColor Yellow
$requiredScopes = @("RoleManagement.ReadWrite.Directory", "RoleManagement.Read.Directory")
try {
    Connect-MgGraph -Scopes $requiredScopes -ErrorAction Stop
    Write-Host "‚úì Conectado a Microsoft Graph como: $((Get-MgContext).Account)" -ForegroundColor Green
}
catch {
    Write-Error "No se pudo conectar a Microsoft Graph. Aseg√∫rate de tener el m√≥dulo instalado y conexi√≥n a internet."
    exit 1
}

# --- VALIDACI√ìN DEL CSV ---
if (-not (Test-Path $CsvPath)) {
    Write-Error "El archivo CSV no se encontr√≥ en la ruta especificada: $CsvPath"
    exit 1
}

try {
    $roleSettingsFromCsv = Import-Csv -Path $CsvPath
    Write-Host "‚úì CSV cargado correctamente: $($roleSettingsFromCsv.Count) roles" -ForegroundColor Green
}
catch {
    Write-Error "Error al cargar el CSV: $_"
    exit 1
}

# Validar columnas requeridas
$requiredColumns = @('RoleDisplayName', 'ActivationMaxDuration', 'RequireMfaOnActivation', 'RequireApproval')
$csvHeaders = $roleSettingsFromCsv[0].PSObject.Properties.Name

foreach ($col in $requiredColumns) {
    if ($col -notin $csvHeaders) {
        Write-Error "Falta columna requerida en CSV: $col"
        exit 1
    }
}

# Mostrar resumen de configuraci√≥n
Show-ConfigurationSummary -CsvData $roleSettingsFromCsv

# Confirmaci√≥n para modo producci√≥n
if (-not $DryRun -and -not $Force) {
    Write-Host "`n‚ö†Ô∏è  ADVERTENCIA: Se aplicar√°n cambios en MODO PRODUCCI√ìN" -ForegroundColor Red
    $confirm = Read-Host "¬øContinuar? (escriba 'SI' para confirmar)"
    if ($confirm -ne 'SI') {
        Write-Host "Operaci√≥n cancelada por el usuario." -ForegroundColor Yellow
        exit 0
    }
}

# --- PROCESAMIENTO PRINCIPAL ---
Write-Host "`nProcesando configuraciones de roles..." -ForegroundColor Cyan
if ($DryRun) {
    Write-Host "[MODO DRY-RUN ACTIVO - No se aplicar√°n cambios reales]" -ForegroundColor Yellow
}

$results = @()
$progress = 0

foreach ($row in $roleSettingsFromCsv) {
    $progress++
    $roleDisplayName = $row.RoleDisplayName
    Write-Progress -Activity "Procesando pol√≠ticas PIM" -Status "Rol $progress de $($roleSettingsFromCsv.Count): $roleDisplayName" -PercentComplete (($progress / $roleSettingsFromCsv.Count) * 100)
    
    Write-Host "`n[$progress/$($roleSettingsFromCsv.Count)] Procesando: $roleDisplayName" -ForegroundColor White
    
    $script:Statistics.Total++
    
    try {
        # --- VALIDACI√ìN INICIAL ---
        if (-not (Test-RoleConfigurable -RoleDisplayName $roleDisplayName)) {
            Write-Host "  ‚Üí OMITIDO: Rol no configurable" -ForegroundColor Yellow
            $script:Statistics.Skipped++
            Add-AuditEntry -RoleDisplayName $roleDisplayName -Action "RoleNotConfigurable" -Status "Skipped" -Details "Rol no est√° en lista blanca"
            continue
        }
        
        # --- OBTENER CONFIGURACI√ìN ACTUAL ---
        $roleDefinition = Invoke-WithRetry -ScriptBlock {
            Get-MgRoleManagementDirectoryRoleDefinition -Filter "DisplayName eq '$roleDisplayName'"
        }
        
        if (-not $roleDefinition) {
            Write-Host "  ‚Üí ERROR: Rol no encontrado en el directorio" -ForegroundColor Red
            $script:Statistics.Failed++
            Add-AuditEntry -RoleDisplayName $roleDisplayName -Action "RoleNotFound" -Status "Failed" -Details "Rol no existe en Entra ID"
            continue
        }
        
        $roleDefinitionId = $roleDefinition.Id
        
        $currentSettings = Invoke-WithRetry -ScriptBlock {
            Get-MgRoleManagementDirectoryRoleSetting -UnifiedRoleDefinitionId $roleDefinitionId
        }
        
        $beforeState = @{
            ActivationMaxDuration = $currentSettings.ActivationMaximumDuration
            RequireJustification = $currentSettings.IsJustificationRequiredOnActivation
            RequireMfa = $currentSettings.IsMfaOnActivationRequired
            RequireApproval = $currentSettings.IsApprovalRequiredOnActivation
            RequireTicketInfo = $currentSettings.IsTicketInfoRequiredOnActivation
        }
        
        # --- PREPARAR NUEVA CONFIGURACI√ìN ---
        $proposedMfa = [System.Convert]::ToBoolean($row.RequireMfaOnActivation)
        $proposedApproval = [System.Convert]::ToBoolean($row.RequireApproval)
        
        # --- VALIDAR CAMBIOS NO AUTORIZADOS ---
        $unauthorizedChanges = Test-UnauthorizedChanges -RoleDisplayName $roleDisplayName `
            -CurrentMfa $beforeState.RequireMfa -ProposedMfa $proposedMfa `
            -CurrentApproval $beforeState.RequireApproval -ProposedApproval $proposedApproval `
            -CurrentDuration $beforeState.ActivationMaxDuration -ProposedDuration $row.ActivationMaxDuration
        
        if ($unauthorizedChanges.Count -gt 0) {
            Write-Host "  ‚Üí BLOQUEADO: Cambios no autorizados detectados:" -ForegroundColor Red
            $unauthorizedChanges | ForEach-Object { Write-Host "    ‚Ä¢ $_" -ForegroundColor Red }
            
            $script:Statistics.UnauthorizedChanges++
            Add-AuditEntry -RoleDisplayName $roleDisplayName -Action "UnauthorizedChanges" -Status "Blocked" `
                -Details ($unauthorizedChanges -join "; ") -BeforeState $beforeState
            continue
        }
        
        # --- MODO DRY-RUN ---
        if ($DryRun) {
            Write-Host "  [DRY-RUN] Simulando actualizaci√≥n..." -ForegroundColor Cyan
            Write-Host "    Duraci√≥n: $($beforeState.ActivationMaxDuration) ‚Üí $($row.ActivationMaxDuration)" -ForegroundColor Gray
            Write-Host "    MFA: $($beforeState.RequireMfa) ‚Üí $proposedMfa" -ForegroundColor Gray
            Write-Host "    Aprobaci√≥n: $($beforeState.RequireApproval) ‚Üí $proposedApproval" -ForegroundColor Gray
            
            $script:Statistics.Success++
            Add-AuditEntry -RoleDisplayName $roleDisplayName -Action "DryRunSimulated" -Status "Success" `
                -Details "Cambios simulados" -BeforeState $beforeState
            continue
        }
        
        # --- APLICAR CONFIGURACI√ìN REAL ---
        $params = @{
            UnifiedRoleDefinitionId = $roleDefinitionId
            ActivationMaximumDuration = $row.ActivationMaxDuration
            IsJustificationRequiredOnActivation = [System.Convert]::ToBoolean($row.RequireJustificationOnActivation)
            IsMfaOnActivationRequired = $proposedMfa
            IsApprovalRequiredOnActivation = $proposedApproval
            IsTicketInfoRequiredOnActivation = [System.Convert]::ToBoolean($row.RequireTicketInfoOnActivation)
        }
        
        Write-Host "  ‚Üí Aplicando cambios..." -ForegroundColor Yellow
        Invoke-WithRetry -ScriptBlock {
            Update-MgRoleManagementDirectoryRoleSetting @params
        }
        
        # --- VERIFICAR CONFIGURACI√ìN ACTUALIZADA ---
        $newSettings = Invoke-WithRetry -ScriptBlock {
            Get-MgRoleManagementDirectoryRoleSetting -UnifiedRoleDefinitionId $roleDefinitionId
        }
        
        $afterState = @{
            ActivationMaxDuration = $newSettings.ActivationMaximumDuration
            RequireJustification = $newSettings.IsJustificationRequiredOnActivation
            RequireMfa = $newSettings.IsMfaOnActivationRequired
            RequireApproval = $newSettings.IsApprovalRequiredOnActivation
            RequireTicketInfo = $newSettings.IsTicketInfoRequiredOnActivation
        }
        
        Write-Host "  ‚úì Configuraci√≥n actualizada exitosamente" -ForegroundColor Green
        $script:Statistics.Success++
        
        Add-AuditEntry -RoleDisplayName $roleDisplayName -Action "PolicyUpdated" -Status "Success" `
            -Details "Configuraci√≥n aplicada exitosamente" -BeforeState $beforeState -AfterState $afterState
        
        # --- AGREGAR AL REPORTE DETALLADO ---
        $results += [PSCustomObject]@{ 
            Rol = $roleDisplayName; 
            Propiedad = "Duraci√≥n M√°xima Activaci√≥n"; 
            Valor_Antes = $beforeState.ActivationMaxDuration; 
            Valor_Despues = $afterState.ActivationMaxDuration; 
            Modificado = -not ($beforeState.ActivationMaxDuration -eq $afterState.ActivationMaxDuration) 
        }
        $results += [PSCustomObject]@{ 
            Rol = $roleDisplayName; 
            Propiedad = "Requiere MFA"; 
            Valor_Antes = $beforeState.RequireMfa; 
            Valor_Despues = $afterState.RequireMfa; 
            Modificado = -not ($beforeState.RequireMfa -eq $afterState.RequireMfa) 
        }
        $results += [PSCustomObject]@{ 
            Rol = $roleDisplayName; 
            Propiedad = "Requiere Aprobaci√≥n"; 
            Valor_Antes = $beforeState.RequireApproval; 
            Valor_Despues = $afterState.RequireApproval; 
            Modificado = -not ($beforeState.RequireApproval -eq $afterState.RequireApproval) 
        }
        
    }
    catch {
        Write-Host "  ‚Üí ERROR: $($_.Exception.Message)" -ForegroundColor Red
        $script:Statistics.Failed++
        Add-AuditEntry -RoleDisplayName $roleDisplayName -Action "Error" -Status "Failed" -Details $_.Exception.Message
    }
}

Write-Progress -Activity "Procesando pol√≠ticas PIM" -Completed

# --- REPORTES FINALES ---
Write-Host "`n--- Reporte de Cambios ---" -ForegroundColor Yellow
if ($results.Count -gt 0) {
    $results | Format-Table -AutoSize
} else {
    Write-Host "No se realizaron cambios o no hay datos para mostrar." -ForegroundColor Gray
}

# Exportar auditor√≠a detallada
Write-Host "`nGenerando reportes de auditor√≠a..." -ForegroundColor Cyan
Export-AuditReport

# Mensaje final
if ($DryRun) {
    Write-Host "`n‚úÖ SIMULACI√ìN COMPLETADA - Revise el reporte antes de ejecutar en producci√≥n" -ForegroundColor Green
} else {
    Write-Host "`n‚úÖ CONFIGURACI√ìN COMPLETADA - Los cambios han sido aplicados" -ForegroundColor Green
}

# --- DESCONEXI√ìN ---
Write-Host "`nDesconectando de Microsoft Graph..." -ForegroundColor Yellow
Disconnect-MgGraph -ErrorAction SilentlyContinue
Write-Host "Script finalizado." -ForegroundColor Green
